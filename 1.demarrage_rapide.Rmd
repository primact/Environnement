---
title: 'SimBEL - Démarrage rapide'
author: Quentin Guibert, Prim'Act
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true 
    toc_float: true
    number_sections: true
---

Dans cet exemple, nous présentons le lancement des calculs de best estimate pour un portefeuille de produits d'épargne.

# Chargement du package et des données

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(plyr)
library(dplyr)
library(ggplot2)
```

```{r, echo=T, message=FALSE, warning=FALSE}
library(SimBEL)

rm(list = ls())

racine <- new("Initialisation", root_address = getwd())

# Chargement des adresses 
racine <- set_architecture(racine)

# # Creation  du canton initial
# init_SimBEL(racine)
#
# # Creation des cantons associes a chacun des chocs de la formule standard
# init_scenario(racine)
```


# Lancement d'un calcul de BE central

```{r, echo=T, message=F, warning=FALSE}
# Chargement du 'Be' et de l'actif correspondant a la situation centrale
central       <- get(load(paste(racine@address$save_folder$central, "best_estimate.RData", sep = "/")))

# Calcul BE pour chaque situation
#-----------------------------------
# si on veut enregistrer les resultats en base, l'objet Be doit avoir un argument base initialise
central@base <- new("DataBase", file_adress = paste(racine@root_address,
                                                    "internal_ws/data/database", sep = "/"),
                    ecriture_base = T, choc_name = "central")
central@base@ecriture_base <- F

# Affiche l'heure de demarrage de la simulation
start_time <- Sys.time()

# Calcul du BE avec 4 coeurs
BE_central_result <- run_be(x = central, pre_on = F, parallel = T, nb_coeur = 4L)
```

```{r, echo=F, message=T, warning=FALSE}
 # Messages de fin
  # Affiche l'heure de fin de la simulation
  end_time <- Sys.time()
  time_taken <- end_time - start_time
  message(paste("Temps necessaire a l'evaluation sur une centaine de MP: ", as.numeric(time_taken, units = "mins"), " minutes", sep = ""))
```

# Affichage de résultats
## Flux actualisés
```{r, echo=F, message=T, warning=FALSE}
message("Visualisation du BE par grand poste")
print((BE_central_result$be@tab_be))
```

## Chroniques de flux moyens
```{r, echo=F, message=T, warning=FALSE}
message("Visualiation du BE par grand poste")
tab <- data.frame(temps = 1:50, flux = BE_central_result$be@tab_flux$prestation[,1], type = "prestations")
tab <- rbind(tab,
              data.frame(temps = 1:50, flux = BE_central_result$be@tab_flux$frais[,1], type = "frais")
)

p <- ggplot(tab, aes(x=temps, y = flux, fill = type))
p + geom_bar(stat="identity")
```


# Calcul d'un SCR

## Chargement des environnements de chocs
```{r, echo=T, message=F, warning=FALSE}
# Load the objets 'Be' related to the shocks of the central formula
action_type_1 <- get(load(paste(racine@address$save_folder$action_type1, "best_estimate.RData", sep = "/")))
action_type_2 <- get(load(paste(racine@address$save_folder$action_type2, "best_estimate.RData", sep = "/")))
immo          <- get(load(paste(racine@address$save_folder$immo, "best_estimate.RData", sep = "/")))
spread        <- get(load(paste(racine@address$save_folder$spread, "best_estimate.RData", sep = "/")))
taux_up       <- get(load(paste(racine@address$save_folder$taux_up, "best_estimate.RData", sep = "/")))
taux_down     <- get(load(paste(racine@address$save_folder$taux_down, "best_estimate.RData", sep = "/")))
frais         <- get(load(paste(racine@address$save_folder$frais, "best_estimate.RData", sep = "/")))
mortalite     <- get(load(paste(racine@address$save_folder$mortalite, "best_estimate.RData", sep = "/")))
longevite     <- get(load(paste(racine@address$save_folder$longevite, "best_estimate.RData", sep = "/")))
rachat_up     <- get(load(paste(racine@address$save_folder$rachat_up, "best_estimate.RData", sep = "/")))
rachat_down   <- get(load(paste(racine@address$save_folder$rachat_down, "best_estimate.RData", sep = "/")))
```

## Calcul des BE sur chaque environnement de choc
```{r, echo=T, message=F, warning=FALSE, results='hide'}
BE_central_result       <- run_be(x = central, pre_on = F, parallel = F, nb_coeur = 0L)

action_type_1@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "action_type_1")
action_type_1@base@ecriture_base <- F
BE_action_type_1_result <- run_be(action_type_1, pre_on = F, parallel = F, nb_coeur = 0L)

action_type_2@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "action_type_2")
action_type_2@base@ecriture_base <- F
BE_action_type_2_result <- run_be(action_type_2, pre_on = F, parallel = F, nb_coeur = 0L)

immo@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "immo")
immo@base@ecriture_base <- F
BE_immo_result          <- run_be(immo, pre_on = F, parallel = F, nb_coeur = 0L)

spread@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "spread")
spread@base@ecriture_base <- F
BE_spread_result        <-run_be(spread, pre_on = F, parallel = F, nb_coeur = 0L)

taux_up@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "taux_up")
taux_up@base@ecriture_base <- F
BE_taux_up_result       <- run_be(taux_up, pre_on = F, parallel = F, nb_coeur = 0L)

taux_down@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "taux_down")
taux_down@base@ecriture_base <- F
BE_taux_down_result     <- run_be(taux_down, pre_on = F, parallel = F, nb_coeur = 0L)

frais@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "frais")
frais@base@ecriture_base <- F
BE_frais_result         <- run_be(frais, pre_on = F, parallel = F, nb_coeur = 0L)

mortalite@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "mortalite")
mortalite@base@ecriture_base <- F
BE_mortalite_result     <- run_be(mortalite, pre_on = F, parallel = F, nb_coeur = 0L)

longevite@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "longevite")
longevite@base@ecriture_base <- F
BE_longevite_result     <- run_be(longevite, pre_on = F, parallel = F, nb_coeur = 0L)

rachat_up@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "rachat_up")
rachat_up@base@ecriture_base <- F
BE_rachat_up_result     <- run_be(rachat_up,pre_on = F, parallel = F, nb_coeur = 0L)


rachat_down@base <- new("DataBase", file_adress = paste(racine@root_address, "internal_ws/data/database", sep = "/"), ecriture_base = T, choc_name = "rachat_down")
rachat_down@base@ecriture_base <- F
BE_rachat_down_result   <- run_be(rachat_down, pre_on = F, parallel = F, nb_coeur = 0L)

```


## Calcul des SCR
```{r, echo=T, message=F, warning=FALSE}

# Get all the shocked best estimate
BE_central       <- BE_central_result$be@tab_be$be[1, 1]
BE_action_type_1 <- BE_action_type_1_result$be@tab_be$be[1, 1]
BE_action_type_2 <- BE_action_type_2_result$be@tab_be$be[1, 1]
BE_immo          <- BE_immo_result$be@tab_be$be[1, 1]
BE_spread        <- BE_spread_result$be@tab_be$be[1, 1]
BE_taux_up       <- BE_taux_up_result$be@tab_be$be[1, 1]
BE_taux_down     <- BE_taux_down_result$be@tab_be$be[1, 1]
BE_frais         <- BE_frais_result$be@tab_be$be[1, 1]
BE_mortalite     <- BE_mortalite_result$be@tab_be$be[1, 1]
BE_longevite     <- BE_longevite_result$be@tab_be$be[1, 1]
BE_rachat_up     <- BE_rachat_up_result$be@tab_be$be[1, 1]
BE_rachat_down   <- BE_rachat_down_result$be@tab_be$be[1, 1]


# Get all the shocked assets
ACTIF_central       <- print_alloc(central@canton@ptf_fin)[5,1]
ACTIF_action_type_1 <- print_alloc(action_type_1@canton@ptf_fin)[5,1]
ACTIF_action_type_2 <- print_alloc(action_type_2@canton@ptf_fin)[5,1]
ACTIF_immo          <- print_alloc(immo@canton@ptf_fin)[5,1]
ACTIF_spread        <- print_alloc(spread@canton@ptf_fin)[5,1]
ACTIF_taux_up       <- print_alloc(taux_up@canton@ptf_fin)[5,1]
ACTIF_taux_down     <- print_alloc(taux_down@canton@ptf_fin)[5,1]


# Compute the SCRs for market risk
SCR_action_type_1 <- max(0, (ACTIF_central - BE_central) - (ACTIF_action_type_1 - BE_action_type_1))
SCR_action_type_2 <- max(0, (ACTIF_central - BE_central) - (ACTIF_action_type_2 - BE_action_type_2))
SCR_immo          <- max(0, (ACTIF_central - BE_central) - (ACTIF_immo - BE_immo))
SCR_spread        <- max(0, (ACTIF_central - BE_central) - (ACTIF_spread - BE_spread))
SCR_taux_up       <- max(0, (ACTIF_central - BE_central) - (ACTIF_taux_up - BE_taux_up))
SCR_taux_down     <- max(0, (ACTIF_central - BE_central) - (ACTIF_taux_down - BE_taux_down))
SCR_taux          <- max(SCR_taux_up, SCR_taux_down)


# Compute the SCRs for life underwriting risk
SCR_mortalite    <- max(0, (ACTIF_central - BE_central) - (ACTIF_central - BE_mortalite))
SCR_longevite    <- max(0, (ACTIF_central - BE_central) - (ACTIF_central - BE_longevite))
SCR_rachat_up    <- max(0, (ACTIF_central - BE_central) - (ACTIF_central - BE_rachat_up))
SCR_rachat_down  <- max(0, (ACTIF_central - BE_central) - (ACTIF_central - BE_rachat_down))
SCR_rachat       <- max(SCR_rachat_up, SCR_rachat_down)
SCR_frais        <- max(0, (ACTIF_central - BE_central) - (ACTIF_central - BE_frais))

#---Aggregate the SCR Equity  ---
corrActionType1 <- c(1, 0.75) 
corrActionType2 <- c(0.75 , 1)
MatCorrAction   <- matrix(c(corrActionType1, corrActionType2), nrow = 2, dimnames = list(c("ActionType1", "ActionType2")))

#--- Correlation matrix - Market risks  ---
corrTaux      <- c(1, 0.5, 0.5, 0.5, 0.25) 
corrActions   <- c(0.5, 1, 0.75, 0.75, 0.25)
corrImmo      <- c(0.5, 0.75, 1, 0.5, 0.25)
corrSpread    <- c(0.5, 0.75, 0.5, 1, 0.25)
corrChange    <- c(0.25, 0.25, 0.25, 0.25, 1)
MatCorrMarche <- matrix(c(corrTaux, corrActions, corrImmo, corrSpread, corrChange),
                        nrow = 5, dimnames = list(c("Taux", "Actions", "Immo", "Spread", "Change"), 
                                                  c("Taux", "Actions", "Immo", "Spread", "Change")))

#--- Correlation matrix - Life risks ---
corrMort   <- c(1, -0.25, 0, 0.25)
corrLong   <- c(-0.25, 1, 0.25, 0.25)
corrRachat <- c(0, 0.25, 1, 0.5)
corrFrais  <- c(0.25, 0.25, 0.5, 1)
MatCorrVie <- matrix(c(corrMort, corrLong, corrRachat, corrFrais),
                     nrow = 4, dimnames = list(c("Mort", "Long", "Rachat","Frais"),
                                               c("Mort", "Long", "Rachat","Frais")))

#--- COrrelation matrix- BSCR  ---
corrMarche  <- c(1, 0.25)
corrVie     <- c(0.25, 1)
MatCorrBSCR <- matrix(c(corrMarche, corrVie), nrow = 2, dimnames = list(c("Marche", "VIE"),c("Marche", "VIE")))

# SCR Equity
vectSCRAction   <- t(rbind(SCR_action_type_1, SCR_action_type_2))
aggregerAction  <- function(ligne){sqrt(t(vectSCRAction[ligne, ]) %*% MatCorrAction %*% vectSCRAction[ligne, ])}
SCR_action      <- as.numeric(aggregerAction(1))

print(SCR_action)

# Compute SCR Market
vectSCRMarche   <- t(rbind(SCR_taux, SCR_action, SCR_immo, SCR_spread, SCR_change = 0))
aggregerMarche  <- function(ligne){sqrt(t(vectSCRMarche[ligne, ]) %*% MatCorrMarche %*% vectSCRMarche[ligne, ])}
SCRMarche       <- as.numeric(aggregerMarche(1))

print(SCRMarche)

# Compute SCR Life
vectSCRVie  <- cbind(SCR_mortalite, SCR_longevite, SCR_rachat, SCR_frais)
aggregerVie	<- function(ligne){sqrt(t(vectSCRVie[ligne, ]) %*% MatCorrVie %*% vectSCRVie[ligne, ])}
SCRVie      <- as.numeric(aggregerVie(1))

print(SCRVie)

# Compute the BSCR
vectBSCR		  <- cbind(SCRMarche, SCRVie)
aggregerBSCR <- function(ligne){sqrt(t(vectBSCR[ligne, ]) %*% MatCorrBSCR %*% vectBSCR[ligne, ])}
BSCR         <- as.numeric(aggregerBSCR(1))

print(BSCR)
```
